# Userflow 명세서

## 목차
1. [회원가입 및 로그인 플로우](#1-회원가입-및-로그인-플로우)
2. [첫 사주 분석 플로우 (무료 사용자)](#2-첫-사주-분석-플로우-무료-사용자)
3. [Pro 구독 플로우](#3-pro-구독-플로우)
4. [사주 분석 목록 조회 및 상세보기 플로우](#4-사주-분석-목록-조회-및-상세보기-플로우)
5. [프로필 관리 플로우](#5-프로필-관리-플로우)
6. [구독 관리 플로우](#6-구독-관리-플로우)
7. [PDF 다운로드 및 공유 플로우](#7-pdf-다운로드-및-공유-플로우)

---

## 1. 회원가입 및 로그인 플로우

### 1.1 신규 회원가입 (소셜 로그인)

#### 입력
- 사용자가 홈 페이지의 '회원가입' 버튼 클릭
- Clerk 회원가입 모달 표시
- 사용자가 구글 소셜 로그인 버튼 클릭

#### 처리
1. Clerk가 구글 OAuth 인증 프로세스 시작
2. 사용자가 구글 계정 선택 및 권한 승인
3. Clerk가 사용자 정보를 받아 계정 생성
4. Clerk webhook을 통해 백엔드에 사용자 생성 이벤트 전달
5. 백엔드 서비스 처리:
   - `POST /api/auth/webhook` 엔드포인트 호출
   - Supabase `users` 테이블에 사용자 레코드 생성
   - 초기 데이터 설정:
     - `subscription_tier`: 'free'
     - `remaining_analyses`: 3
     - `created_at`: 현재 시간
6. JWT 세션 토큰 생성 및 클라이언트에 전달

#### 출력
- **성공 시:**
  - 사용자 세션 활성화
  - 대시보드 페이지로 리다이렉트
  - 환영 토스트 메시지 표시
- **실패 시:**
  - Clerk 에러 메시지 표시 (예: 이미 가입된 계정, 네트워크 오류)
  - 회원가입 모달 유지

#### 엣지케이스
- **구글 인증 중단:** 사용자가 중간에 취소한 경우 홈 페이지로 복귀
- **Webhook 실패:** Clerk 계정은 생성되었으나 Supabase 동기화 실패 시, 다음 로그인 시도 시 재시도 로직 실행
- **중복 가입 시도:** 이미 존재하는 계정인 경우 로그인 플로우로 안내

---

### 1.2 기존 회원 로그인

#### 입력
- 사용자가 홈 페이지의 '로그인' 버튼 클릭
- Clerk 로그인 모달 표시
- 사용자가 구글 소셜 로그인 버튼 클릭

#### 처리
1. Clerk가 구글 OAuth 인증 프로세스 시작
2. 사용자가 구글 계정 선택
3. Clerk가 기존 사용자 정보 확인
4. JWT 세션 토큰 생성
5. 클라이언트에서 세션 상태 업데이트

#### 출력
- **성공 시:**
  - 사용자 세션 활성화
  - 이전에 방문하려던 페이지 또는 대시보드로 리다이렉트
- **실패 시:**
  - Clerk 에러 메시지 표시
  - 로그인 모달 유지

#### 엣지케이스
- **미가입 계정:** 해당 구글 계정으로 가입된 정보가 없는 경우 회원가입 플로우로 안내
- **세션 만료:** 기존 세션이 만료된 경우 자동으로 재로그인 프롬프트 표시

---

### 1.3 로그아웃

#### 입력
- 사용자가 헤더의 프로필 아이콘 클릭
- 드롭다운 메뉴에서 '로그아웃' 선택

#### 처리
1. 클라이언트에서 Clerk 로그아웃 함수 호출
2. 세션 토큰 무효화
3. 로컬 상태 초기화 (Zustand, React Query 캐시 클리어)

#### 출력
- 홈 페이지로 리다이렉트
- 로그아웃 완료 토스트 메시지 표시

#### 엣지케이스
- **네트워크 오류:** 로그아웃 요청 실패 시에도 클라이언트 세션은 클리어하고 홈으로 이동

---

### 1.4 회원 탈퇴

#### 입력
- 사용자가 헤더의 프로필 아이콘 클릭
- 드롭다운 메뉴에서 '회원 탈퇴' 선택
- 확인 다이얼로그 표시
- 사용자가 탈퇴 사유 선택 (선택사항) 및 '탈퇴하기' 버튼 클릭

#### 처리
1. 클라이언트에서 `DELETE /api/auth/account` API 호출
2. 백엔드 서비스 처리:
   - 현재 사용자의 구독 상태 확인
   - Pro 구독자인 경우 토스페이먼츠 빌링키 삭제 API 호출
   - Supabase에서 관련 데이터 처리:
     - `user_analyses` 소프트 삭제 (deleted_at 설정)
     - `user_profiles` 소프트 삭제
     - `users` 소프트 삭제
   - Clerk API를 통해 사용자 계정 삭제
3. 세션 무효화

#### 출력
- **성공 시:**
  - 홈 페이지로 리다이렉트
  - 회원 탈퇴 완료 메시지 표시
- **실패 시:**
  - 에러 메시지 표시 (예: 구독 취소 처리 중 오류)
  - 다이얼로그 유지하여 재시도 가능하도록 함

#### 엣지케이스
- **활성 구독 중:** Pro 구독이 활성화된 경우 탈퇴 전 구독 취소가 먼저 필요함을 안내
- **삭제 실패 롤백:** 일부 데이터만 삭제된 경우 트랜잭션 롤백 또는 재시도 로직 필요
- **탈퇴 후 재가입:** 동일 계정으로 재가입 시 새로운 사용자로 처리 (이전 데이터 복구 불가)

---

## 2. 첫 사주 분석 플로우 (무료 사용자)

### 2.1 신규 사용자의 첫 분석 시작

#### 입력
- 신규 가입 후 대시보드에서 '새 분석하기' 버튼 클릭
- 새 분석하기 페이지 진입
- 페이지 로드 시 사용자 분석 잔여 횟수 확인

#### 처리
1. 클라이언트에서 `GET /api/user/quota` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 현재 사용자의 `remaining_analyses` 조회
   - 구독 상태 및 잔여 횟수 반환
3. 클라이언트에서 잔여 횟수 상태 업데이트

#### 출력
- 페이지 상단에 잔여 분석 횟수 배지 표시 (예: "남은 분석 3회")
- 잔여 횟수가 3회 이하인 경우 알림 배너 표시

#### 엣지케이스
- **잔여 횟수 0회:** 분석 폼 대신 Pro 구독 안내 페이지 표시
- **API 오류:** 잔여 횟수 조회 실패 시 기본값으로 처리하되 분석 시작 시 재확인

---

### 2.2 사주 정보 입력

#### 입력 (새로 입력하기 탭)
- 사용자가 폼에 정보 입력:
  - 이름 (텍스트 필드)
  - 성별 (라디오 버튼: 남성/여성)
  - 생년월일 (날짜 선택기)
  - 음력/양력 선택 (토글 스위치)
  - 태어난 시간 (시간 선택 드롭다운)
  - 분석 종류 선택 (라디오 버튼: 평생 운세/신년 운세/월간 운세)
- 프로필로 저장 여부 체크박스 선택 (선택사항)
- '분석 시작' 버튼 클릭

#### 처리
1. 클라이언트 측 입력 유효성 검증:
   - 필수 필드 입력 확인
   - 날짜 형식 검증
   - 태어난 시간 유효 범위 확인
2. 유효성 검증 통과 시 로딩 상태 활성화
3. `POST /api/analysis/create` API 호출:
   ```json
   {
     "name": "홍길동",
     "gender": "male",
     "birthDate": "1990-05-15",
     "birthTime": "14:30",
     "isLunar": false,
     "analysisType": "yearly",
     "saveAsProfile": true
   }
   ```
4. 백엔드 서비스 처리:
   - 사용자 잔여 횟수 재확인 (동시성 제어)
   - 잔여 횟수 부족 시 에러 반환
   - 사주팔자 데이터 전처리:
     - 생년월일시를 간지(干支) 데이터로 변환
     - 십신(十神), 대운(大運) 계산
   - AI 분석 요청 준비:
     - 무료 사용자이므로 `gemini-2.5-flash` 모델 선택
     - 구조화된 프롬프트 생성 (사주 데이터 + 분석 요청)
   - Google Gemini API 호출
   - AI 응답 JSON 파싱 및 검증
   - Supabase에 분석 결과 저장:
     - `user_analyses` 테이블에 레코드 생성
     - JSON 결과 저장
   - 사용자 잔여 횟수 차감 (트랜잭션)
   - 프로필 저장 요청 시 `user_profiles` 테이블에 레코드 생성
5. 분석 ID 반환

#### 출력
- **성공 시:**
  - 로딩 화면 표시 ("운명을 해석하고 있습니다...")
  - 완료 후 분석 상세보기 페이지로 리다이렉트 (`/analysis/{analysisId}`)
  - 성공 토스트 메시지 표시
- **실패 시:**
  - 에러 타입에 따른 메시지 표시:
    - 잔여 횟수 부족: Pro 구독 안내 다이얼로그
    - AI API 오류: 재시도 안내 메시지 (횟수 차감 안됨)
    - 네트워크 오류: 네트워크 확인 안내
  - 입력 폼 유지 (입력값 보존)

#### 엣지케이스
- **동시 분석 요청:** 여러 탭에서 동시에 분석 시작 시 서버 측에서 트랜잭션으로 방지
- **AI 응답 지연:** 30초 이상 소요 시 타임아웃 처리 및 에러 반환
- **잘못된 JSON 응답:** AI가 유효하지 않은 JSON 반환 시 재시도 로직 (최대 2회)
- **음력 날짜 변환 오류:** 유효하지 않은 음력 날짜인 경우 에러 메시지 표시

---

### 2.3 불러오기 탭을 통한 프로필 선택

#### 입력
- 사용자가 '불러오기' 탭 클릭
- 저장된 프로필 목록 표시
- 사용자가 프로필 선택
- 분석 종류 선택
- '분석 시작' 버튼 클릭

#### 처리
1. 탭 전환 시 `GET /api/profiles` API 호출
2. 백엔드에서 현재 사용자의 프로필 목록 반환
3. 클라이언트에서 프로필 목록 렌더링
4. 사용자가 프로필 선택 시 해당 정보로 폼 자동 입력
5. 이후 과정은 2.2와 동일

#### 출력
- 프로필 목록 카드 형태로 표시 (이름, 생년월일)
- 선택된 프로필 정보 강조 표시
- 분석 시작 후 2.2와 동일한 플로우 진행

#### 엣지케이스
- **프로필 없음:** 빈 상태 메시지 표시 및 '새로 입력하기' 탭으로 안내
- **프로필 로드 실패:** 에러 메시지 표시 및 재시도 버튼 제공

---

## 3. Pro 구독 플로우

### 3.1 구독 페이지 진입

#### 입력
- 사용자가 헤더의 '구독 관리' 메뉴 클릭
- 또는 무료 횟수 소진 후 안내 다이얼로그에서 '구독하기' 버튼 클릭

#### 처리
1. `/subscription` 페이지로 이동
2. `GET /api/subscription/status` API 호출
3. 백엔드 서비스 처리:
   - Supabase에서 사용자의 구독 정보 조회
   - 현재 구독 상태, 잔여 횟수, 다음 결제일 등 반환

#### 출력
- 현재 구독 상태 표시:
  - **무료 사용자:** Pro 요금제 안내 카드
  - **Pro 구독자:** 현재 요금제 정보 및 관리 옵션
  - **취소 예정:** 만료 예정일 및 재활성화 옵션
- Pro 요금제 혜택 표시:
  - 월 10회 분석
  - 고급 AI 모델 사용
  - 가격 정보

#### 엣지케이스
- **API 오류:** 기본 상태(무료)로 표시하되 에러 배너 표시

---

### 3.2 Pro 구독 결제 시작

#### 입력
- 무료 사용자가 'Pro 구독하기' 버튼 클릭
- 결제 정보 입력 모달 표시

#### 처리
1. 토스페이먼츠 SDK 초기화
2. 클라이언트에서 `POST /api/payment/prepare` API 호출
3. 백엔드 서비스 처리:
   - 결제 세션 생성
   - 주문 ID 생성 및 Supabase에 임시 저장
   - 결제 준비 정보 반환
4. 토스페이먼츠 결제창 호출:
   ```javascript
   tossPayments.requestBillingAuth({
     method: '카드',
     successUrl: `${baseUrl}/payment/success`,
     failUrl: `${baseUrl}/payment/fail`,
     customerName: user.name,
     customerEmail: user.email
   })
   ```

#### 출력
- 토스페이먼츠 결제창 팝업 표시
- 사용자가 카드 정보 입력 및 인증 진행

#### 엣지케이스
- **결제창 차단:** 팝업 차단 안내 메시지 표시
- **준비 API 실패:** 에러 메시지 표시 및 재시도 옵션

---

### 3.3 결제 성공 처리

#### 입력
- 토스페이먼츠에서 `successUrl`로 리다이렉트
- URL 파라미터로 `authKey`, `customerKey` 전달

#### 처리
1. `/payment/success` 페이지 로드
2. `POST /api/payment/confirm` API 호출:
   ```json
   {
     "authKey": "...",
     "customerKey": "...",
     "orderId": "..."
   }
   ```
3. 백엔드 서비스 처리:
   - 토스페이먼츠 빌링키 발급 API 호출
   - 빌링키 저장
   - 첫 결제 실행 (토스페이먼츠 결제 API)
   - 결제 성공 시 Supabase 업데이트:
     - `users` 테이블:
       - `subscription_tier`: 'pro'
       - `remaining_analyses`: 10
       - `billing_key`: 발급된 빌링키
       - `subscription_start_date`: 현재 시간
       - `next_billing_date`: 1개월 후
     - `payment_history` 테이블에 결제 내역 저장
   - Supabase Cron 작업 등록 (다음 결제일에 자동 결제)

#### 출력
- **성공 시:**
  - 결제 완료 페이지 표시
  - 구독 활성화 안내 메시지
  - 3초 후 대시보드로 자동 리다이렉트
  - 환영 토스트 메시지 표시
- **실패 시:**
  - 결제 실패 페이지 표시
  - 실패 사유 안내
  - 재시도 또는 고객센터 연락 옵션

#### 엣지케이스
- **빌링키 발급 성공, 첫 결제 실패:** 빌링키 삭제 후 에러 반환
- **중복 결제 방지:** `orderId`로 중복 확인하여 이미 처리된 경우 스킵
- **네트워크 오류 중 처리 중단:** Webhook을 통한 비동기 처리로 보완

---

### 3.4 결제 실패 처리

#### 입력
- 토스페이먼츠에서 `failUrl`로 리다이렉트
- URL 파라미터로 에러 정보 전달

#### 처리
1. `/payment/fail` 페이지 로드
2. 에러 코드 파싱
3. 사용자 친화적인 메시지로 변환

#### 출력
- 결제 실패 페이지 표시
- 실패 사유 표시 (예: 카드 한도 초과, 인증 실패)
- '다시 시도하기' 버튼 (구독 페이지로 복귀)
- '취소' 버튼 (대시보드로 복귀)

#### 엣지케이스
- **알 수 없는 에러:** 일반적인 에러 메시지 표시 및 고객센터 연락 안내

---

### 3.5 정기 결제 (자동)

#### 입력
- Supabase Cron이 매일 특정 시간에 실행
- 다음 결제일이 오늘인 사용자 목록 조회

#### 처리
1. Cron 함수 실행: `processRecurringPayments()`
2. Supabase에서 `next_billing_date`가 오늘이고 `subscription_tier`가 'pro'인 사용자 조회
3. 각 사용자에 대해:
   - 저장된 빌링키로 토스페이먼츠 결제 API 호출
   - 결제 성공 시:
     - `remaining_analyses`: 10으로 리셋
     - `next_billing_date`: 1개월 후로 업데이트
     - `payment_history` 테이블에 결제 내역 추가
   - 결제 실패 시:
     - 재시도 로직 (최대 3회, 하루 간격)
     - 3회 실패 시 구독 취소 처리 및 이메일 알림

#### 출력
- Cron 실행 로그 기록
- 결제 실패한 사용자에게 이메일 알림 (선택사항)

#### 엣지케이스
- **빌링키 만료:** 결제 실패 처리 및 사용자에게 재등록 안내
- **대량 처리 시 성능:** 배치 처리로 부하 분산
- **Cron 실행 실패:** 다음 실행 시 누락된 결제 재처리

---

## 4. 사주 분석 목록 조회 및 상세보기 플로우

### 4.1 대시보드 (분석 목록) 조회

#### 입력
- 사용자가 헤더의 '분석 목록' 메뉴 클릭
- 또는 로그인 후 기본 페이지로 자동 이동

#### 처리
1. `/dashboard` 페이지 로드
2. `GET /api/analysis/list` API 호출:
   ```
   ?page=1&limit=10&sortBy=createdAt&order=desc
   ```
3. 백엔드 서비스 처리:
   - Supabase에서 현재 사용자의 분석 목록 조회
   - 페이지네이션 적용
   - 정렬 및 필터 적용
   - 각 분석의 기본 정보 반환:
     - 분석 ID
     - 대상 이름
     - 분석 종류
     - 생성 날짜
     - 썸네일 또는 아이콘

#### 출력
- 분석 목록을 카드 형태로 표시 (3열 그리드)
- 각 카드에 표시:
  - 대상 이름
  - 분석 종류 배지
  - 생성일
  - 호버 시 삭제 버튼 표시
- 페이지네이션 컨트롤 (이전/다음, 페이지 번호)
- 빈 상태일 경우 '첫 분석 시작하기' 안내

#### 엣지케이스
- **분석 없음:** 빈 상태 일러스트 및 '새 분석하기' 버튼
- **API 오류:** 에러 메시지 표시 및 새로고침 버튼

---

### 4.2 검색 및 필터링

#### 입력
- 사용자가 검색창에 이름 입력 및 엔터
- 또는 필터 드롭다운에서 분석 종류 선택

#### 처리
1. 검색/필터 상태 업데이트
2. `GET /api/analysis/list` API 재호출:
   ```
   ?page=1&limit=10&search=홍길동&analysisType=yearly
   ```
3. 백엔드에서 필터 조건에 맞는 목록 반환

#### 출력
- 필터링된 분석 목록 표시
- 검색 키워드 하이라이트
- 필터 태그 표시 (제거 가능)
- 결과 없을 시 '검색 결과 없음' 메시지

#### 엣지케이스
- **특수문자 입력:** SQL 인젝션 방지 처리
- **빈 검색어:** 전체 목록 표시

---

### 4.3 분석 삭제

#### 입력
- 사용자가 분석 카드의 삭제 버튼 클릭
- 확인 다이얼로그 표시
- 사용자가 '삭제' 버튼 클릭

#### 처리
1. `DELETE /api/analysis/{analysisId}` API 호출
2. 백엔드 서비스 처리:
   - 해당 분석이 현재 사용자 소유인지 확인
   - Supabase에서 소프트 삭제 (`deleted_at` 설정)
   - 성공 응답 반환
3. 클라이언트에서 React Query 캐시 무효화
4. 목록 자동 갱신

#### 출력
- **성공 시:**
  - 해당 카드가 목록에서 제거 (애니메이션)
  - 삭제 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시
  - 목록 유지

#### 엣지케이스
- **권한 없음:** 에러 메시지 표시 및 목록 새로고침
- **이미 삭제된 항목:** 무시하고 목록에서 제거

---

### 4.4 분석 상세보기

#### 입력
- 사용자가 분석 카드 클릭

#### 처리
1. `/analysis/{analysisId}` 페이지로 이동
2. `GET /api/analysis/{analysisId}` API 호출
3. 백엔드 서비스 처리:
   - 해당 분석이 현재 사용자 소유인지 확인
   - Supabase에서 분석 전체 데이터 조회
   - JSON 결과 파싱하여 반환

#### 출력
- 분석 결과를 섹션별로 표시:
  - 헤더: 대상 이름, 생년월일, 분석 종류
  - 총운 섹션 (이모지 포함)
  - 재물운 섹션
  - 애정운 섹션
  - 건강운 섹션
  - 직업운 섹션
- 각 섹션은 카드 형태로 구분
- 하단에 액션 버튼:
  - PDF로 저장
  - 공유하기
  - 삭제하기
- 로딩 중 스켈레톤 UI 표시

#### 엣지케이스
- **존재하지 않는 분석:** 404 페이지 표시
- **권한 없음:** 403 에러 페이지 표시 및 대시보드로 리다이렉트
- **JSON 파싱 오류:** 에러 메시지 표시 및 원본 데이터 로그 기록

---

## 5. 프로필 관리 플로우

### 5.1 프로필 목록 조회

#### 입력
- 사용자가 '새 분석하기' 페이지의 '불러오기' 탭 클릭
- 또는 설정 페이지에서 '프로필 관리' 메뉴 선택

#### 처리
1. `GET /api/profiles` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 현재 사용자의 프로필 목록 조회
   - 생성일 기준 정렬

#### 출력
- 프로필 목록 카드 형태로 표시:
  - 이름
  - 성별 아이콘
  - 생년월일
  - 편집/삭제 버튼
- '새 프로필 추가' 버튼

#### 엣지케이스
- **프로필 없음:** 빈 상태 메시지 및 추가 안내
- **API 오류:** 에러 메시지 및 재시도 옵션

---

### 5.2 프로필 추가

#### 입력
- 사용자가 '새 프로필 추가' 버튼 클릭
- 프로필 추가 다이얼로그 표시
- 사용자가 정보 입력:
  - 이름
  - 성별
  - 생년월일
  - 음력/양력
  - 태어난 시간
- '저장' 버튼 클릭

#### 처리
1. 클라이언트 측 유효성 검증
2. `POST /api/profiles` API 호출:
   ```json
   {
     "name": "김철수",
     "gender": "male",
     "birthDate": "1985-03-20",
     "birthTime": "10:00",
     "isLunar": false
   }
   ```
3. 백엔드 서비스 처리:
   - 중복 프로필 확인 (같은 이름, 생년월일)
   - Supabase `user_profiles` 테이블에 레코드 생성
   - 생성된 프로필 ID 반환

#### 출력
- **성공 시:**
  - 다이얼로그 닫기
  - 프로필 목록 자동 갱신
  - 새 프로필 추가 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시 (예: 중복 프로필)
  - 다이얼로그 유지

#### 엣지케이스
- **중복 프로필:** 기존 프로필 사용 또는 다른 이름 사용 안내
- **최대 개수 제한:** 무료 사용자는 최대 5개, Pro 사용자는 무제한으로 제한 적용

---

### 5.3 프로필 수정

#### 입력
- 사용자가 프로필 카드의 편집 버튼 클릭
- 프로필 수정 다이얼로그 표시 (기존 정보 자동 입력)
- 사용자가 정보 수정
- '저장' 버튼 클릭

#### 처리
1. 클라이언트 측 유효성 검증
2. `PATCH /api/profiles/{profileId}` API 호출
3. 백엔드 서비스 처리:
   - 해당 프로필이 현재 사용자 소유인지 확인
   - Supabase에서 프로필 정보 업데이트
   - 업데이트된 프로필 반환

#### 출력
- **성공 시:**
  - 다이얼로그 닫기
  - 프로필 목록 자동 갱신
  - 수정 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시
  - 다이얼로그 유지

#### 엣지케이스
- **권한 없음:** 에러 메시지 표시
- **존재하지 않는 프로필:** 404 에러 처리

---

### 5.4 프로필 삭제

#### 입력
- 사용자가 프로필 카드의 삭제 버튼 클릭
- 확인 다이얼로그 표시
- 사용자가 '삭제' 버튼 클릭

#### 처리
1. `DELETE /api/profiles/{profileId}` API 호출
2. 백엔드 서비스 처리:
   - 해당 프로필이 현재 사용자 소유인지 확인
   - Supabase에서 소프트 삭제
   - 성공 응답 반환

#### 출력
- **성공 시:**
  - 해당 카드가 목록에서 제거
  - 삭제 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시
  - 목록 유지

#### 엣지케이스
- **프로필 사용 중:** 삭제해도 기존 분석 내역에는 영향 없음 안내
- **마지막 프로필 삭제:** 경고 없이 삭제 가능 (프로필은 필수 아님)

---

## 6. 구독 관리 플로우

### 6.1 구독 상태 조회

#### 입력
- 사용자가 '구독 관리' 페이지 접근

#### 처리
1. `GET /api/subscription/status` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 사용자 구독 정보 조회
   - 구독 상태, 잔여 횟수, 다음 결제일 반환

#### 출력
- 현재 구독 정보 카드:
  - 구독 상태 배지 (무료/Pro/취소 예정)
  - 월간 분석 제공 횟수 및 잔여 횟수 프로그레스 바
  - 다음 결제일 (Pro인 경우)
  - 사용 중인 AI 모델 정보
- 구독 상태별 액션 버튼:
  - **무료:** 'Pro 구독하기'
  - **Pro:** '구독 취소하기'
  - **취소 예정:** '구독 재활성화'

#### 엣지케이스
- **API 오류:** 기본 상태로 표시 및 에러 배너

---

### 6.2 구독 취소

#### 입력
- Pro 구독자가 '구독 취소하기' 버튼 클릭
- 확인 다이얼로그 표시:
  - 취소 시 안내 사항 (다음 결제일까지 혜택 유지, 이후 만료)
  - 크레딧 이월 불가 정책 안내
- 사용자가 '취소' 버튼 클릭

#### 처리
1. `POST /api/subscription/cancel` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 구독 상태를 'pending_cancel'로 업데이트
   - 만료 예정일 설정 (현재 `next_billing_date`)
   - Supabase Cron에서 자동 결제 스케줄 제거
   - **빌링키는 유지** (재활성화 대비)

#### 출력
- **성공 시:**
  - 구독 상태 카드 업데이트 (취소 예정 표시)
  - 만료 예정일 표시
  - '구독 재활성화' 버튼 활성화
  - 취소 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시
  - 다이얼로그 닫기

#### 엣지케이스
- **이미 취소된 구독:** 중복 처리 방지
- **네트워크 오류:** 재시도 옵션 제공

---

### 6.3 구독 재활성화

#### 입력
- 취소 예정 상태의 사용자가 '구독 재활성화' 버튼 클릭
- 확인 다이얼로그 표시
- 사용자가 '재활성화' 버튼 클릭

#### 처리
1. `POST /api/subscription/reactivate` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 구독 상태를 'pro'로 복원
   - Supabase Cron에 자동 결제 스케줄 재등록
   - 빌링키 유효성 확인

#### 출력
- **성공 시:**
  - 구독 상태 카드 업데이트 (Pro 활성 상태)
  - 다음 결제일 표시
  - '구독 취소하기' 버튼 활성화
  - 재활성화 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시
  - 빌링키 만료 시 재결제 안내

#### 엣지케이스
- **빌링키 만료:** 재결제 플로우로 안내
- **만료일 지난 후 재활성화:** 불가능, 재구독 필요

---

### 6.4 구독 만료 (자동)

#### 입력
- Supabase Cron이 매일 실행
- 만료 예정일이 오늘이고 상태가 'pending_cancel'인 사용자 조회

#### 처리
1. Cron 함수 실행: `processExpiredSubscriptions()`
2. 각 사용자에 대해:
   - 토스페이먼츠 빌링키 삭제 API 호출
   - Supabase 업데이트:
     - `subscription_tier`: 'free'
     - `remaining_analyses`: 3
     - `billing_key`: null
     - `subscription_end_date`: 현재 시간
   - 이메일 알림 발송 (선택사항)

#### 출력
- Cron 실행 로그 기록
- 만료된 사용자에게 이메일 알림

#### 엣지케이스
- **빌링키 삭제 실패:** 재시도 로직
- **대량 처리:** 배치 처리로 부하 분산

---

### 6.5 재구독 (만료 후)

#### 입력
- 만료된 사용자가 '구독 관리' 페이지에서 'Pro 구독하기' 버튼 클릭

#### 처리
- 3.2~3.3과 동일한 신규 구독 플로우 진행
- 새로운 빌링키 발급

#### 출력
- 신규 구독과 동일

#### 엣지케이스
- **이전 결제 수단 재사용 불가:** 새로운 카드 정보 입력 필요

---

## 7. PDF 다운로드 및 공유 플로우

### 7.1 PDF 다운로드

#### 입력
- 사용자가 분석 상세보기 페이지에서 'PDF로 저장' 버튼 클릭

#### 처리
1. 클라이언트에서 로딩 상태 활성화
2. `POST /api/analysis/{analysisId}/pdf` API 호출
3. 백엔드 서비스 처리:
   - 해당 분석이 현재 사용자 소유인지 확인
   - 분석 데이터 조회
   - PDF 생성 라이브러리 사용 (예: Puppeteer, jsPDF):
     - 분석 상세보기 페이지와 동일한 레이아웃으로 렌더링
     - 이모지 및 스타일 포함
   - 생성된 PDF를 Supabase Storage에 업로드 (선택사항)
   - PDF 바이너리 또는 다운로드 URL 반환
4. 클라이언트에서 PDF 다운로드 트리거

#### 출력
- **성공 시:**
  - 브라우저 다운로드 시작
  - 파일명: `사주분석_[이름]_[날짜].pdf`
  - 다운로드 완료 토스트 메시지
- **실패 시:**
  - 에러 메시지 표시 (예: PDF 생성 실패)
  - 재시도 옵션

#### 엣지케이스
- **PDF 생성 타임아웃:** 30초 이상 소요 시 에러 처리
- **대용량 데이터:** 압축 또는 페이지 분할 처리
- **브라우저 호환성:** 다운로드 방식 fallback 제공

---

### 7.2 카카오톡 공유

#### 입력
- 사용자가 분석 상세보기 페이지에서 '공유하기' 버튼 클릭
- 공유 옵션 다이얼로그 표시
- 사용자가 '카카오톡으로 공유' 선택

#### 처리
1. 카카오 SDK 초기화 확인
2. 공유용 URL 생성:
   - `POST /api/analysis/{analysisId}/share` API 호출
   - 백엔드에서 공개 공유 토큰 생성 (UUID)
   - Supabase에 공유 토큰 저장 (만료 시간: 7일)
   - 공유 URL 반환: `https://domain.com/share/{shareToken}`
3. 카카오 SDK를 통해 카카오톡 공유:
   ```javascript
   Kakao.Link.sendDefault({
     objectType: 'feed',
     content: {
       title: '[이름]님의 사주 분석 결과',
       description: '운명의 해석을 확인해보세요',
       imageUrl: 'https://domain.com/og-image.png',
       link: {
         mobileWebUrl: shareUrl,
         webUrl: shareUrl
       }
     }
   })
   ```

#### 출력
- 카카오톡 공유 다이얼로그 표시
- 사용자가 대화방 선택 및 전송
- 공유 완료 토스트 메시지

#### 엣지케이스
- **카카오톡 미설치:** 웹 링크 공유로 fallback
- **SDK 초기화 실패:** 에러 메시지 및 링크 복사로 대체 안내
- **공유 토큰 만료:** 7일 후 접근 시 만료 안내 페이지

---

### 7.3 링크 복사

#### 입력
- 사용자가 공유 다이얼로그에서 '링크 복사' 선택

#### 처리
1. 7.2와 동일하게 공유 URL 생성
2. 클라이언트에서 Clipboard API 사용:
   ```javascript
   navigator.clipboard.writeText(shareUrl)
   ```

#### 출력
- **성공 시:**
  - 링크 복사 완료 토스트 메시지
  - 다이얼로그 닫기
- **실패 시:**
  - fallback: URL을 텍스트 필드에 표시하여 수동 복사 유도

#### 엣지케이스
- **Clipboard API 미지원:** fallback UI 제공
- **권한 거부:** 사용자에게 권한 허용 안내

---

### 7.4 공유 링크 접근

#### 입력
- 외부 사용자가 공유 링크 접근: `/share/{shareToken}`

#### 처리
1. `GET /api/share/{shareToken}` API 호출
2. 백엔드 서비스 처리:
   - Supabase에서 공유 토큰 조회
   - 만료 여부 확인 (7일 경과)
   - 유효하면 해당 분석 데이터 반환 (민감 정보 제외)
3. 공유 전용 페이지 렌더링

#### 출력
- **유효한 링크:**
  - 분석 결과 읽기 전용 페이지 표시
  - '나도 분석하기' CTA 버튼 (회원가입 유도)
- **만료된 링크:**
  - 만료 안내 페이지
  - 홈으로 이동 버튼
- **잘못된 링크:**
  - 404 페이지

#### 엣지케이스
- **삭제된 분석:** 접근 불가 안내
- **소유자가 탈퇴:** 분석 데이터는 유지되므로 접근 가능 (정책에 따라 조정)

---

## 추가 공통 엣지케이스

### 네트워크 오류 처리
- **모든 API 호출:**
  - 네트워크 오류 시 재시도 로직 (React Query 기본 3회)
  - 사용자에게 '네트워크 연결을 확인하세요' 메시지
  - 재시도 버튼 제공

### 인증 만료 처리
- **모든 인증 필요 페이지:**
  - JWT 토큰 만료 시 자동으로 Clerk 재인증 프롬프트
  - 재인증 후 원래 페이지로 복귀

### 동시성 제어
- **분석 횟수 차감:**
  - 서버 측 트랜잭션으로 동시 요청 방지
  - 낙관적 업데이트 후 실패 시 롤백

### 브라우저 호환성
- **모든 UI:**
  - 최신 2개 버전의 Chrome, Safari, Firefox, Edge 지원
  - 모바일 브라우저 (iOS Safari, Chrome) 지원
  - IE11 미지원 안내 페이지

### 성능 최적화
- **이미지 로딩:**
  - Lazy loading 적용
  - WebP 포맷 사용 (fallback: JPEG)
- **API 응답 캐싱:**
  - React Query로 stale time 설정
  - 분석 목록: 5분
  - 구독 상태: 1분
  - 분석 상세: 무제한 (변경 불가 데이터)

### 접근성
- **모든 페이지:**
  - 키보드 네비게이션 지원
  - ARIA 레이블 적용
  - 스크린 리더 호환
  - 색상 대비비 AA 등급 이상

---

## 페이지 전환 맵

```
[홈] → [로그인] → [대시보드]
              ↓
         [새 분석하기] → [분석 상세보기]
              ↓                ↓
         [프로필 관리]    [PDF 다운로드]
                              ↓
                         [공유하기]

[대시보드] → [구독 관리] → [결제] → [결제 성공/실패]
                    ↓
              [구독 취소] → [재활성화]
```

---

## API 호출 시점 요약

| 페이지/액션 | API 엔드포인트 | 호출 시점 |
|------------|---------------|----------|
| 회원가입 | `POST /api/auth/webhook` | Clerk webhook 수신 시 |
| 로그인 | 없음 (Clerk 처리) | - |
| 로그아웃 | 없음 (클라이언트 처리) | - |
| 회원 탈퇴 | `DELETE /api/auth/account` | 탈퇴 확인 시 |
| 새 분석하기 진입 | `GET /api/user/quota` | 페이지 로드 시 |
| 분석 시작 | `POST /api/analysis/create` | 폼 제출 시 |
| 분석 목록 조회 | `GET /api/analysis/list` | 페이지 로드 시 |
| 분석 상세 조회 | `GET /api/analysis/{id}` | 페이지 로드 시 |
| 분석 삭제 | `DELETE /api/analysis/{id}` | 삭제 확인 시 |
| 프로필 목록 조회 | `GET /api/profiles` | 탭 전환 시 |
| 프로필 추가 | `POST /api/profiles` | 추가 폼 제출 시 |
| 프로필 수정 | `PATCH /api/profiles/{id}` | 수정 폼 제출 시 |
| 프로필 삭제 | `DELETE /api/profiles/{id}` | 삭제 확인 시 |
| 구독 상태 조회 | `GET /api/subscription/status` | 페이지 로드 시 |
| 구독 시작 | `POST /api/payment/prepare` | 구독 버튼 클릭 시 |
| 결제 확인 | `POST /api/payment/confirm` | 토스 결제 성공 콜백 시 |
| 구독 취소 | `POST /api/subscription/cancel` | 취소 확인 시 |
| 구독 재활성화 | `POST /api/subscription/reactivate` | 재활성화 버튼 클릭 시 |
| PDF 생성 | `POST /api/analysis/{id}/pdf` | PDF 버튼 클릭 시 |
| 공유 링크 생성 | `POST /api/analysis/{id}/share` | 공유 버튼 클릭 시 |
| 공유 링크 접근 | `GET /api/share/{token}` | 공유 페이지 로드 시 |

---

**문서 작성일:** 2025-10-24
**버전:** 1.0.0
